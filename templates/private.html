{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
  <h2>Chat dengan {{receiver}}</h2>
  <a href="{{url_for('dashboard')}}" class="btn btn-secondary btn-sm mb-2"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</a>
  <div class="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
    {% for message in messages %}
    <div class="chat-bubble {{ 'me' if message.sender == username else 'other' }} mb-2 p-2 rounded">
      <strong>{{message.sender}}</strong>: {{message.message}}
      <small class="d-block">{{message.timestamp.strftime('%H:%M')}}</small>
      <div class="reactions">
        {% for emoji, users in message.get('reactions', {}).items() %}
        <span>{{emoji}} ({{users|length}})</span>
        {% endfor %}
      </div>
      <select onchange="addReaction('{{message._id}}', 'private', this.value)" class="form-select form-select-sm d-inline-block w-auto">
        <option value="">Pilih Reaksi</option>
        <option value="üòä">üòä</option>
        <option value="üëç">üëç</option>
        <option value="‚ù§Ô∏è">‚ù§Ô∏è</option>
      </select>
    </div>
    {% endfor %}
  </div>
  <div id="typing-indicator" class="mt-2"></div>
  <form id="message-form" class="mt-2">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="Ketik pesan..." />
      <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Kirim</button>
    </div>
  </form>
</div>
<script>
  const socket = io();
  socket.on('connect', () => {
    socket.emit('connect', {});
  });

  socket.on('private_message', (msg) => {
    const chatContainer = document.querySelector('.chat-container');
    const div = document.createElement('div');
    div.className = `chat-bubble ${msg.sender === '{{username}}' ? 'me' : 'other'} mb-2 p-2 rounded`;
    div.innerHTML = `<strong>${msg.sender}</strong>: ${msg.message}<small class="d-block">${new Date(msg.timestamp).toLocaleTimeString()}</small><div class="reactions"></div>`;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  socket.on('typing', (data) => {
    const typingIndicator = document.getElementById('typing-indicator');
    if (data.isTyping) {
      typingIndicator.innerHTML = `<small>${data.username} sedang mengetik...</small>`;
    } else {
      typingIndicator.innerHTML = '';
    }
  });

  document.getElementById('message-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    if (input.value.trim()) {
      socket.emit('private_message', { message: input.value });
      input.value = '';
    }
  });

  document.getElementById('message-input').addEventListener('input', () => {
    socket.emit('typing', { isTyping: true });
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => {
      socket.emit('typing', { isTyping: false });
    }, 1000);
  });

  function addReaction(messageId, messageType, emoji) {
    fetch(`/react/${messageType}/${messageId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `emoji=${encodeURIComponent(emoji)}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error);
      }
    });
  }

  document.querySelector('.chat-container').scrollTop = document.querySelector('.chat-container').scrollHeight;
</script>
{% endblock %}