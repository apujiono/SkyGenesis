{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
  <h2 class="animate__animated animate__fadeIn">Room: {{room}}</h2>
  <a href="{{url_for('dashboard')}}" class="btn btn-secondary btn-sm mb-2"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</a>
  <div id="chat-container" class="chat-container">
    {% for message in messages %}
    <div class="chat-bubble {{ 'me' if message.sender == username else 'other' }} mb-2 p-2 rounded animate__animated animate__slideInUp" data-id="{{message._id}}">
      <strong>{{message.sender}}</strong>: {{message.message}}
      <small class="d-block">{{message.timestamp.strftime('%H:%M')}}</small>
      <div class="read-receipt">
        {% if message.read_by|length > 1 %}
        Dibaca oleh {{message.read_by|reject('equalto', username)|join(', ')}}
        {% else %}
        Terkirim
        {% endif %}
      </div>
      <div class="reactions">
        {% for emoji, users in message.get('reactions', {}).items() %}
        <span data-emoji="{{emoji}}">{{emoji}} ({{users|length}})</span>
        {% endfor %}
      </div>
      <div class="d-flex align-items-center mt-1">
        <select onchange="addReaction('{{message._id}}', 'room', this.value)" class="form-select form-select-sm d-inline-block w-auto">
          <option value="">Pilih Reaksi</option>
          <option value="ğŸ˜Š">ğŸ˜Š</option>
          <option value="ğŸ‘">ğŸ‘</option>
          <option value="â¤ï¸">â¤ï¸</option>
        </select>
        {% if message.sender == username %}
        <button onclick="deleteMessage('{{message._id}}', 'room')" class="btn btn-danger btn-sm ms-2"><i class="fas fa-trash"></i></button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  <div id="typing-indicator" class="mt-2"></div>
  <form id="message-form" class="mt-2">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="Ketik pesan..." autocomplete="off" />
      <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Kirim</button>
    </div>
  </form>
  <div id="connection-status" class="mt-2"></div>
</div>
<script>
  socket.on('room_message', (msg) => {
    const chatContainer = document.getElementById('chat-container');
    const div = document.createElement('div');
    div.className = `chat-bubble ${msg.sender === '{{username}}' ? 'me' : 'other'} mb-2 p-2 rounded animate__animated animate__slideInUp`;
    div.dataset.id = msg._id;
    div.innerHTML = `
      <strong>${msg.sender}</strong>: ${msg.message}
      <small class="d-block">${new Date(msg.timestamp).toLocaleTimeString()}</small>
      <div class="read-receipt">Terkirim</div>
      <div class="reactions"></div>
      <div class="d-flex align-items-center mt-1">
        <select onchange="addReaction('${msg._id}', 'room', this.value)" class="form-select form-select-sm d-inline-block w-auto">
          <option value="">Pilih Reaksi</option>
          <option value="ğŸ˜Š">ğŸ˜Š</option>
          <option value="ğŸ‘">ğŸ‘</option>
          <option value="â¤ï¸">â¤ï¸</option>
        </select>
        ${msg.sender === '{{username}}' ? `<button onclick="deleteMessage('${msg._id}', 'room')" class="btn btn-danger btn-sm ms-2"><i class="fas fa-trash"></i></button>` : ''}
      </div>
    `;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    socket.emit('message_read', { message_id: msg._id, message_type: 'room' });
  });

  socket.on('message_read', (data) => {
    const bubble = document.querySelector(`[data-id="${data.message_id}"] .read-receipt`);
    if (bubble) {
      const readBy = bubble.textContent.includes('Dibaca') ? bubble.textContent.replace('Dibaca oleh ', '').split(', ') : [];
      if (!readBy.includes(data.username)) {
        readBy.push(data.username);
        bubble.textContent = readBy.length > 1 ? `Dibaca oleh ${readBy.filter(u => u !== '{{username}}').join(', ')}` : 'Terkirim';
      }
    }
  });

  socket.on('message_deleted', (data) => {
    const bubble = document.querySelector(`[data-id="${data.message_id}"]`);
    if (bubble && data.message_type === 'room') {
      bubble.remove();
    }
  });

  socket.on('reaction', (data) => {
    const bubble = document.querySelector(`[data-id="${data.message_id}"] .reactions`);
    if (bubble) {
      const existing = bubble.querySelector(`span[data-emoji="${data.emoji}"]`);
      if (existing) {
        const count = parseInt(existing.textContent.match(/\d+/)[0]) + 1;
        existing.textContent = `${data.emoji} (${count})`;
      } else {
        bubble.innerHTML += `<span data-emoji="${data.emoji}">${data.emoji} (1)</span>`;
      }
    }
  });

  socket.on('typing', (data) => {
    const typingIndicator = document.getElementById('typing-indicator');
    if (data.isTyping && data.username !== '{{username}}') {
      typingIndicator.innerHTML = `<small>${data.username} sedang mengetik...</small>`;
    } else {
      typingIndicator.innerHTML = '';
    }
  });

  document.getElementById('message-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    if (input.value.trim()) {
      socket.emit('room_message', { message: input.value });
      input.value = '';
      socket.emit('typing', { isTyping: false });
    }
  });

  document.getElementById('message-input').addEventListener('input', () => {
    socket.emit('typing', { isTyping: true });
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => {
      socket.emit('typing', { isTyping: false });
    }, 1000);
  });

  function addReaction(messageId, messageType, emoji) {
    if (!emoji) return;
    fetch(`/react/${messageType}/${messageId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `emoji=${encodeURIComponent(emoji)}`
    })
    .then(response => response.json())
    .then(data => {
      if (!data.success) {
        showToast(data.error, 'danger');
      }
    })
    .catch(error => {
      console.error('Error adding reaction:', error);
      showToast('Gagal menambah reaksi', 'danger');
    });
  }

  function deleteMessage(messageId, messageType) {
    fetch(`/delete_message/${messageType}/${messageId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('Pesan dihapus');
        const bubble = document.querySelector(`[data-id="${messageId}"]`);
        if (bubble) bubble.remove();
      } else {
        showToast(data.error, 'danger');
      }
    })
    .catch(error => {
      console.error('Error deleting message:', error);
      showToast('Gagal menghapus pesan', 'danger');
    });
  }

  document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;

  // Mark messages as read on load
  document.querySelectorAll('.chat-bubble').forEach(bubble => {
    socket.emit('message_read', { message_id: bubble.dataset.id, message_type: 'room' });
  });
</script>
{% endblock %}