{% extends 'base.html' %} {% block content %}
<div id="room-container">
  <h2>Room {{room}}</h2>
  <div id="room-subsection">
    <h3>Code Room: <span>{{room}}</span></h3>
    <a href="{{url_for('dashboard')}}" class="btn"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</a>
    <a href="/" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
  <div id="chat-room-widget">
    <div id="typing-indicator"></div>
    <div id="msgs-container">
      <ul id="messages"></ul>
      <button id="load-more" class="btn" onclick="loadMore(1)">Load More</button>
    </div>
    <div id="message-box">
      <input type="text" placeholder="Masukkan pesan" id="message-input" name="message" />
      <button type="submit" id="send-btn" onclick="sendMessage()" class="btn"><i class="fas fa-paper-plane"></i> Kirim</button>
    </div>
  </div>
  <script type="text/javascript">
    var socketio = io();
    var page = 1;
    var isTyping = false;
    socketio.on("message", function (message) { createChatItem(message._id, message.message, message.sender, message.reactions) });
    socketio.on("typing", function (data) {
      var indicator = document.getElementById("typing-indicator");
      if (data.isTyping) {
        indicator.innerHTML = `<p>${data.username} sedang mengetik...</p>`;
      } else {
        indicator.innerHTML = "";
      }
    });
    function createChatItem(id, message, sender, reactions) {
      var messages = document.getElementById("messages");
      if (sender === "") {
        content = `<p class="member-activity">${message}</p>`;
      } else {
        var senderIsUser = "{{username}}" === sender;
        var reactionHtml = Object.entries(reactions || {}).map(([emoji, users]) => 
          `<span class="reaction">${emoji} ${users.length}</span>`
        ).join(' ');
        var content = `
          <li class="message-item ${senderIsUser ? "self-message-item" : "peer-message-item"}" data-id="${id}">
              <p>${message}</p>
              <small class="${senderIsUser ? "muted-text" : "muted-text-white"}">${new Date().toLocaleString()}</small>
              <div class="reactions">${reactionHtml}</div>
              <button onclick="react('${id}', 'üòä')">üòä</button>
              <button onclick="react('${id}', 'üëç')">üëç</button>
          </li>
        `;
      }
      messages.innerHTML += content;
      messages.scrollTop = messages.scrollHeight;
    }
    function sendMessage() {
      var msgInput = document.getElementById("message-input");
      if (msgInput.value === "") return;
      var msg = msgInput.value;
      socketio.emit("room_message", { message: msg });
      msgInput.value = "";
      socketio.emit("typing", { isTyping: false });
    }
    function loadMore(nextPage) {
      fetch(`/room/{{room}}/more/${nextPage}`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            data.reverse().forEach(msg => createChatItem(msg._id, msg.message, msg.sender, msg.reactions));
            page = nextPage;
            document.getElementById("load-more").onclick = () => loadMore(page + 1);
          } else {
            document.getElementById("load-more").style.display = "none";
          }
        });
    }
    function react(messageId, emoji) {
      fetch(`/react/room/${messageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `emoji=${encodeURIComponent(emoji)}`
      }).then(() => location.reload());
    }
    document.getElementById("message-input").addEventListener("input", function() {
      if (!isTyping) {
        isTyping = true;
        socketio.emit("typing", { isTyping: true });
      }
      clearTimeout(window.typingTimeout);
      window.typingTimeout = setTimeout(() => {
        isTyping = false;
        socketio.emit("typing", { isTyping: false });
      }, 2000);
    });
  </script>
  {% for message in messages %}
  <script type="text/javascript">
    createChatItem("{{message._id}}", "{{message.message}}", "{{message.sender}}", {{message.reactions|tojson}});
  </script>
  {% endfor %}
</div>
{% endblock %}